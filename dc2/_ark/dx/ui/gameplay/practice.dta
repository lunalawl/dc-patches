(step_index -1)
(section
   "")
(num_steps 0)
(loop_count 0)
(learn_state fast_track)
(start_beat -1)
(end_beat -1)
(queued_start_beat -1)
(queued_end_beat -1)
(suppress_next_start_step FALSE)
(suppress_next_move_score FALSE)
(step_complete FALSE)
(move_beats
   ())
(learn_move_index 0)
(move_results
   ())
(learn_mode_locked FALSE)
(user_action '')
(learn_skip FALSE)
(learn_previous FALSE)
(nav_direction 1)
(suppress_flash_card_pulse FALSE)
(used_previous_this_move FALSE)
(stream_jump_happened_since_navigation FALSE)
(informed_video FALSE)
(informed_slow FALSE)
(want_to_record FALSE)
(video_record FALSE)
(video_replay FALSE)
(video_replay_first_time FALSE)
(video_replay_loop_count 0)
(learn_credit_category 0)
(section_credits 0)
(section_credits_max 0)
(learn_section_result_category 0)
(num_ticks 0)
(miss_streak 0)
(pass_streak 0)
(performance_state '')
(slow_motion FALSE)
(review_move_number 0)
(review_move_count 0)
(review_move_hit_count 0)
(review_move_perfect_count 0)
(review_total_move_count 0)
(review_total_move_hit_count 0)
(play_barks FALSE)
(played_first_express FALSE)
(played_first_3rep FALSE)
(current_move_performed_slow FALSE)
(used_slow_motion FALSE)
(next_loop_start_margin -1)
(vo_spew FALSE)
(init
   {hamprovider set gameplay_mode practice}
   {$this common_init}
   {master
      add_sink
      $this
      (beat stream_jump)}
   {$this reset}
   {$this check_tags}
   {resize
      [cached_loop_cams]
      0}
   {hamprovider
      add_sink
      $this
      ((on_game_stage_change on_game_stage))
      0
      FALSE}
   {audio jump 0}
   {count_in_player set active TRUE}
   {slow_count_in_player set active FALSE}
   {if_else
      {==
         {hamprovider get ui_nav_player}
         0}
      {do
         {{gamedata getp 0 provider}
            set
            join_state
            kJoinPlaying}
         {{gamedata getp 1 provider}
            set
            join_state
            kJoinNoSkeleton}}
      {do
         {{gamedata getp 1 provider}
            set
            join_state
            kJoinPlaying}
         {{gamedata getp 0 provider}
            set
            join_state
            kJoinNoSkeleton}}})
(on_game_stage
   {switch
      {hamprovider get game_stage}
      (playing
         {do
            ($s)
            ($e)
            {if
               {!
                  {audio get_loop_beats $s $e}}
               {$this stream_jump}}}
         {if
            $hamwardrobe
            {$hamwardrobe crowd_end_override}})
      (outro)}
   kDataUnhandled)
(on_intro_start
   {if
      $hud_panel
      {if_else
         $played_long_practice_intro
         {do
            {$hud_panel play nar_ses_intro}}
         {do
            ($ses_intro_vo
               "")
            ($vo_length 0)
            {if_else
               {!
                  {profile_mgr get_disable_voice_practice}}
               {set $ses_intro_vo nar_intro_instructions}
               {set $ses_intro_vo nar_intro_instructions_ges}}
            {$hud_panel get_seq_length $ses_intro_vo}
            {$hud_panel play $ses_intro_vo}
            {set $played_long_practice_intro TRUE}}}}
   kDataUnhandled)
(exit
   {{find_obj $hud_panel practice_options}
      stop_recording}
   {{find_obj $hud_panel practice_options}
      stop_playback}
   {set
      [cached_loop_cams]
      {array 0}})
(game_outro
   {if_else
      {hamprovider get byo_bid}
      {game_panel end_game kRestart}
      {$this game_outro_common}})
(setup_section
   {do
      ($done FALSE)
      ($index 0)
      ($moves
         {{$hamdirector get_world}
            find
            moves})
      ($rev_index -1)
      ($review_indicies
         ())
      {resize $review_indicies 0}
      {if_else
         {hamprovider get byo_bid}
         {do
            {set
               [section]
               {{$hamdirector get_world}
                  find
                  custom.sect}}}
         {do
            {$moves
               iterate
               PracticeSection
               $ps
               {if
                  {==
                     {$ps get difficulty}
                     {gamedata
                        getp
                        {hamprovider get ui_nav_player}
                        difficulty}}
                  {set
                     [section]
                     $ps}}}}}
      {foreach_int
         $i
         0
         {[section]
            size
            (steps)}
         {if
            {==
               {[section]
                  get
                  (steps $i type)}
               review}
            {push_back $review_indicies $i}}}
      {while
         {size $review_indicies}
         {set
            $rev_index
            {last_elem $review_indicies}}
         {resize
            $review_indicies
            {-
               {size $review_indicies}
               1}}
         {if
            {'||'
               {>=
                  {'+' $rev_index 1}
                  {[section]
                     size
                     (steps)}}
               {!=
                  {[section]
                     get
                     (steps
                        {'+' $rev_index 1}
                        type)}
                  recap_results}}
            {[section]
               insert
               (steps
                  {'+' $rev_index 1})
               0}
            {[section]
               set
               (steps
                  {'+' $rev_index 1}
                  type)
               recap_results}
            {[section]
               set
               (steps
                  {'+' $rev_index 1}
                  boundary)
               TRUE}
            {[section]
               set
               (steps
                  {'+' $rev_index 1}
                  start)
               ""}
            {[section]
               set
               (steps
                  {'+' $rev_index 1}
                  end)
               ""}}}})
(determine_seq_start_beat
   ($sfx $done_by_beat $time_accounted)
   {do
      ($sfx_start_beat 0)
      ($sfx_length 0)
      ($done_by_seconds
         {beat_to_seconds $done_by_beat})
      ($time_we_have
         {- $done_by_seconds $time_accounted})
      {set
         $sfx
         {$hud_panel get_seq $sfx}}
      {set
         $sfx_length
         {-
            {$hud_panel get_seq_length $sfx}
            $time_accounted}}
      {if
         {> $sfx_length $time_we_have}
         {$hud_panel
            pick_shorter_seq
            $sfx
            {'+' $time_we_have $time_accounted}}
         {set
            $sfx_length
            {-
               {$hud_panel get_seq_length $sfx}
               $time_accounted}}
         {if
            {> $sfx_length $time_we_have}
            {notify
               "Found case of overlapping SFX "
               $sfx}}}
      {if_else
         {<= $sfx_length 0}
         $done_by_beat
         {do
            {set
               $sfx_start_beat
               {max
                  {seconds_to_beat
                     {- $done_by_seconds $sfx_length}}
                  0}}
            {'*'
               4
               {int
                  {/ $sfx_start_beat 4}}}}}})
(check_tags
   {foreach_int
      $i
      0
      [num_steps]
      {if
         {!=
            {[section]
               get
               (steps $i type)}
            recap_results}
         {if
            {<
               {$this
                  beat_from_tag
                  {[section]
                     get
                     (steps $i start)}}
               0}
            {notify
               "Assign as bug to DC Authoring - Step "
               $i
               " start tag refers to "
               {[section]
                  get
                  (steps $i start)}
               " which does not exist in song."}}
         {if
            {<
               {$this
                  beat_from_tag
                  {[section]
                     get
                     (steps $i end)}}
               0}
            {notify
               "Assign as bug to DC Authoring - Step "
               $i
               " end tag refers to "
               {[section]
                  get
                  (steps $i end)}
               " which does not exist in song."}}}})
(beat_from_tag
   ($tag)
   {do
      ($retVal -1)
      {if
         $hamdirector
         {do
            ($song_anim
               {$hamdirector player_song_anim 0})
            ($frame)
            ($value)
            {$song_anim
               foreach_keyframe
               $hamdirector
               (practice)
               $frame
               $value
               {if
                  {== $tag $value}
                  {set
                     $retVal
                     {round
                        {seconds_to_beat
                           {/ $frame 30}}}}}}}}
      $retVal})
(move_on
   {$this cancel_video_replay}
   {if
      {==
         {hamprovider get skills_mode}
         learn}
      {do
         ($credits
            {elem
               [step_category_credits]
               [learn_credit_category]})
         ($max_credits
            {elem
               [step_category_credits]
               3})
         ($cue
            {elem
               [step_result_category_cues]
               [learn_credit_category]})
         ($category
            [learn_credit_category])
         {'+='
            [section_credits]
            $credits}
         {'+='
            [section_credits_max]
            $max_credits}
         {if
            $hud_panel
            {$hud_panel play $cue}
            {if
               [vo_spew]
               {printf
                  "VO: Step end. Cat. %d adds %d credits for %d / %d. Playing %s.cue.\n"
                  $category
                  $credits
                  [section_credits]
                  [section_credits_max]
                  $cue}}}}}
   {if_else
      [learn_previous]
      {do
         {set
            [nav_direction]
            -1}
         {set
            [used_previous_this_move]
            TRUE}}
      {do
         {set
            [nav_direction]
            1}
         {set
            [used_previous_this_move]
            FALSE}}}
   {set
      [step_complete]
      TRUE}
   {count_in_player clear_events}
   {slow_count_in_player clear_events}
   {do
      ($next_step_index)
      {if
         [learn_previous]
         {if_else
            {==
               {[section]
                  get
                  (steps
                     {-
                        [step_index]
                        1}
                     type)}
               recap_results}
            {-=
               [step_index]
               3}
            {-=
               [step_index]
               2}}}
      {set
         $next_step_index
         {'+'
            [step_index]
            1}}
      {if
         {&&
            [learn_skip]
            {<
               $next_step_index
               [num_steps]}}
         {if
            {==
               {[section]
                  get
                  (steps $next_step_index type)}
               recap_results}
            {'++'
               [step_index]}
            {set
               $next_step_index
               {'+'
                  [step_index]
                  1}}}}
      {if_else
         {<
            $next_step_index
            [num_steps]}
         {do
            ($next_step_start
               {[section]
                  get
                  (steps $next_step_index start)})
            ($next_step_type
               {[section]
                  get
                  (steps $next_step_index type)})
            ($start)
            ($end)
            {audio get_loop_beats $start $end}
            {set
               $start
               {int $start}}
            {set
               $end
               {int $end}}
            {if_else
               {'||'
                  [learn_skip]
                  [learn_previous]}
               {do
                  ($timeline
                     {find_obj $hud_panel dynamic_hud})
                  {$timeline deactivate}
                  {set
                     [start_beat]
                     {-
                        {$this beat_from_tag $next_step_start}
                        8}}
                  {if_else
                     {!
                        {$this is_past_stream_jump_point_of_no_return}}
                     {set
                        $end
                        {'*'
                           4
                           {'+'
                              2
                              {int
                                 {/
                                    {taskmgr beat}
                                    4}}}}}
                     {set
                        $end
                        {'+' $start 4}}}}
               {switch
                  $next_step_type
                  (learn
                     {set
                        [start_beat]
                        {$this
                           determine_seq_start_beat
                           nar_express_short
                           {-
                              {$this beat_from_tag $next_step_start}
                              4}
                           0}})
                  (review
                     {set
                        [start_beat]
                        {-
                           {$this beat_from_tag $next_step_start}
                           12}}
                     {if
                        {!
                           {hamprovider get byo_bid}}
                        {do
                           ($percentage
                              {/
                                 [section_credits]
                                 [section_credits_max]})
                           ($category
                              {$this
                                 calc_result_category
                                 $percentage
                                 [learn_result_category_thresholds]})
                           ($cue
                              {$hud_panel
                                 get_seq
                                 {elem
                                    [learn_result_category_cues]
                                    $category}})
                           ($cue_length
                              {$hud_panel get_seq_length $cue})
                           ($cue_finish_beat
                              {seconds_to_beat
                                 {'+'
                                    {beat_to_seconds
                                       {'+' $end 0.5}}
                                    $cue_length}})
                           {set
                              $cue_finish_beat
                              {'*'
                                 4
                                 {int
                                    {'+'
                                       1
                                       {/ $cue_finish_beat 4}}}}}
                           {set $end $cue_finish_beat}
                           {if
                              {<=
                                 8
                                 {-
                                    $end
                                    [end_beat]}}
                              {set
                                 $end
                                 {'+'
                                    [end_beat]
                                    8}}}
                           {while
                              {&&
                                 {>
                                    $end
                                    {master event_beat end}}
                                 {>
                                    $end
                                    [end_beat]}}
                              {-= $end 4}
                              {-=
                                 [start_beat]
                                 4}}
                           {set
                              [learn_section_result_category]
                              $category}
                           {gameplay_event_scheduler reset}
                           {foreach
                              $event
                              (({'+'
                                       [end_beat]
                                       0.5}
                                    $cue)
                                 ({'+'
                                       [end_beat]
                                       1}
                                    deactivate_timeline)
                                 ({'+'
                                       [end_beat]
                                       2}
                                    highlight_awards)
                                 ({'+'
                                       [end_beat]
                                       6}
                                    skills_learn_done)
                                 ({'+'
                                       [end_beat]
                                       10}
                                    {if_else
                                       {&&
                                          {>=
                                             $next_step_index
                                             {-
                                                [num_steps]
                                                2}}
                                          {!
                                             {hamprovider get byo_bid}}}
                                       show_recap_final
                                       show_recap})
                                 ({'+'
                                       [end_beat]
                                       12}
                                    done))
                              {do
                                 ($time
                                    {eval
                                       {elem $event 0}})
                                 {if
                                    {> $time $end}
                                    {set
                                       $time
                                       {'+'
                                          [start_beat]
                                          {- $time $end}}}}
                                 {gameplay_event_scheduler
                                    add_world_message
                                    $time
                                    {eval
                                       {elem $event 1}}}}
                              {gameplay_event_scheduler
                                 reset_to_beat
                                 {taskmgr beat}}}}})
                  (recap_results
                     {if
                        $practice_options_up
                        {handle
                           (hamprovider hide_practice_options)}}
                     {do
                        ($last_song_beat
                           {int
                              {seconds_to_beat
                                 {/
                                    {master song_duration_ms}
                                    1000}}})
                        ($end_buffer 0)
                        {-=
                           $last_song_beat
                           {mod $last_song_beat 4}}
                        {set
                           $end_buffer
                           {-
                              $last_song_beat
                              {'+'
                                 $end
                                 {'*'
                                    4
                                    [recap_results_measures]}}}}
                        {if_else
                           {> $end_buffer 0}
                           {set
                              [start_beat]
                              [end_beat]}
                           {set
                              [start_beat]
                              $start}}})}}
            {if_else
               {$this is_past_stream_jump_point_of_no_return}
               {do
                  {set
                     [queued_start_beat]
                     [start_beat]}
                  {set
                     [queued_end_beat]
                     $end}}
               {$this
                  set_loop
                  [start_beat]
                  $end}}
            {set
               [next_loop_start_margin]
               {round
                  {/
                     {-
                        {$this beat_from_tag $next_step_start}
                        [start_beat]}
                     4}}}}
         {do
            ($percentage
               {/
                  [review_total_move_hit_count]
                  [review_total_move_count]})
            ($category
               {$this
                  calc_result_category
                  $percentage
                  [session_result_category_thresholds]})
            ($cue
               {elem
                  [session_result_category_cues]
                  $category})
            {audio clear_loop}
            {game_panel win}
            {if
               $hud_panel
               {$hud_panel play $cue}
               {if
                  [vo_spew]
                  {printf
                     "VO: Session end. %d / %d moves hit for %d%%. Cat. %d. Playing %s.cue.\n"
                     [review_total_move_hit_count]
                     [review_total_move_count]
                     {int
                        {'*' 100 $percentage}}
                     $category
                     $cue}}}
            {set
               [score]
               {int
                  {'*' 100 $percentage}}}}}})
(stream_jump
   {set
      [suppress_flash_card_pulse]
      FALSE}
   {set
      [stream_jump_happened_since_navigation]
      TRUE}
   {if_else
      {!=
         [queued_start_beat]
         -1}
      {do
         {$this
            set_loop
            [queued_start_beat]
            [queued_end_beat]}}
      {do
         {$hamdirector
            set_lipsync_offsets
            {-
               {-
                  {taskmgr seconds}
                  {master stream_time}}}}
         {if
            $hamwardrobe
            {handle
               ($hamwardrobe crowd skills_ok)}}
         {set
            $desired_loop_start
            [next_loop_start_margin]}
         {if
            [step_complete]
            {'++'
               [step_index]}
            {if
               {&&
                  [section]
                  {>=
                     [step_index]
                     0}}
               {if_else
                  {>
                     [num_steps]
                     [step_index]}
                  {do
                     ($start)
                     ($end)
                     ($step_start
                        {[section]
                           get
                           (steps
                              [step_index]
                              start)})
                     ($step_end
                        {[section]
                           get
                           (steps
                              [step_index]
                              end)})
                     ($this_is_recap_results
                        {==
                           {[section]
                              get
                              (steps
                                 [step_index]
                                 type)}
                           recap_results})
                     {hamprovider
                        set
                        skills_mode
                        {[section]
                           get
                           (steps
                              [step_index]
                              type)}}
                     {{find_obj $hud_panel practice_options}
                        disable_previous
                        {==
                           [step_index]
                           0}}
                     {{find_obj $hud_panel practice_options}
                        refresh}
                     {if
                        {$this
                           is_section_boundary
                           [step_index]
                           [nav_direction]}
                        {$hamdirector set practice_start ''}
                        {$hamdirector set practice_end ''}
                        {if
                           $hud_panel
                           {$this setup_timeline}}}
                     {if
                        $this_is_recap_results
                        {set
                           $step_start
                           {[section]
                              get
                              (steps 0 start)}}
                        {set
                           $step_end
                           {[section]
                              get
                              (steps 0 end)}}}
                     {$hamdirector set practice_start $step_start}
                     {$hamdirector set practice_end $step_end}
                     {$this update_margins}
                     {if_else
                        $this_is_recap_results
                        {do
                           ($cur_start)
                           ($cur_end)
                           ($last_song_beat
                              {seconds_to_beat
                                 {/
                                    {master song_duration_ms}
                                    1000}})
                           {audio get_loop_beats $cur_start $cur_end}
                           {set
                              [start_beat]
                              $cur_start}
                           {set
                              [end_beat]
                              {min
                                 {'+'
                                    [start_beat]
                                    {'*'
                                       4
                                       [recap_results_measures]}}
                                 $last_song_beat}}}
                        {do
                           {if
                              {!
                                 {$hamdirector practice_beats $start $end}}
                              {print
                                 "Please assign to Daniel Chace... (Section "
                                 [section]
                                 ", step "
                                 [step_index]
                                 " has illegal tagging. "
                                 $step_start
                                 " to "
                                 $step_end
                                 ")\n"}}
                           {set
                              [start_beat]
                              {round
                                 {- $start 4}}}
                           {set
                              [end_beat]
                              {round
                                 {'+' $end 4}}}}}
                     {$this initialize_step}
                     {set
                        [play_barks]
                        FALSE}
                     {action_bark_player set_active FALSE}}
                  {$this move_on}}}}
         {set
            [step_complete]
            FALSE}
         {count_in_player
            reset_to_beat
            {taskmgr beat}}
         {slow_count_in_player
            reset_to_beat
            {taskmgr beat}}
         {gameplay_event_scheduler
            reset_to_beat
            {taskmgr beat}}
         {midi_player
            reset_to_beat
            {taskmgr beat}}
         {cond
            ({==
                  [step_index]
                  0}
               {$hamdirector
                  set
                  start_loop_margin
                  [next_loop_start_margin]})
            ({>= $desired_loop_start 0}
               {$hamdirector set start_loop_margin $desired_loop_start})}
         {set
            [next_loop_start_margin]
            -1}}})
(initialize_step
   {switch
      {hamprovider get skills_mode}
      (learn
         {set
            [loop_count]
            0}
         {set
            [video_replay_loop_count]
            0}
         {do
            ($intro_vo
               "")
            ($vo_start_beat 0)
            {if_else
               {hamprovider get byo_bid}
               {set $intro_vo nar_3rep_short}
               {if_else
                  [played_first_express]
                  {set $intro_vo nar_express_short}
                  {do
                     {set $intro_vo nar_express_long}
                     {set
                        [played_first_express]
                        TRUE}}}}
            {if
               {$this
                  is_section_boundary
                  [step_index]
                  [nav_direction]}
               {set
                  [loop_cam_index]
                  0}
               {$this change_camera_angle}}
            {$hud_panel clear_flash_cards 0}
            {$this
               set_loop
               [start_beat]
               [end_beat]}
            {if
               {==
                  [step_index]
                  0}
               {set
                  $vo_start_beat
                  {$this
                     determine_seq_start_beat
                     $intro_vo
                     [start_beat]
                     0}}
               {$this
                  set_loop
                  $vo_start_beat
                  [end_beat]}}
            {if
               {&&
                  {!=
                     [user_action]
                     PREVIOUS}
                  {!=
                     [user_action]
                     CANCEL}}
               {$hud_panel play $intro_vo}}
            {do
               ($cur_hud
                  {elem
                     {$hud_panel get player_huds}
                     0})
               {if
                  $cur_hud
                  {$cur_hud reset_beats}}}
            {$hamdirector set player_freestyle FALSE}}
         {set
            [learn_credit_category]
            3}
         {set
            [miss_streak]
            0}
         {set
            [pass_streak]
            0}
         {set
            [informed_video]
            FALSE}
         {set
            [informed_slow]
            FALSE}
         {set
            [performance_state]
            ''}
         {$this set_learn_state fast_track}
         {if
            $hud_panel
            {$hud_panel set_miss_streak_pct 0}}
         {count_in_player
            set_section
            [start_beat]
            [end_beat]}
         {slow_count_in_player
            set_section
            [start_beat]
            [end_beat]}
         {if
            {&&
               $hud_panel
               {==
                  [loop_count]
                  0}}
            {resize
               [move_beats]
               0}
            {set
               [num_ticks]
               0}
            {do
               ($timeline
                  {$hud_panel find dynamic_hud})
               ($b
                  {'+'
                     [start_beat]
                     4})
               ($num_moves
                  {round
                     {/
                        {-
                           {-
                              [end_beat]
                              [start_beat]}
                           8}
                        4}})
               ($count 0)
               {$timeline deactivate}
               {while
                  {<
                     $b
                     {-
                        [end_beat]
                        4}}
                  {$timeline set_active $b TRUE}
                  {$timeline transfer_award_to_persistent $b}
                  {$timeline introduce $b $count $num_moves}
                  {push_back
                     [move_beats]
                     $b}
                  {'++' $count}
                  {'+=' $b 4}}}})
      (review
         {handle
            ({$hamdirector get_world}
               skills_review)}
         {$this
            set_loop
            [start_beat]
            [end_beat]}
         {set
            [loop_count]
            0}
         {count_in_player clear_events}
         {slow_count_in_player clear_events}
         {do
            ($s)
            ($e)
            {if
               {$hamdirector practice_beats $s $e}
               {count_in_player
                  set_section
                  {- $s 4}
                  -1}}}
         {set
            [section_credits]
            0}
         {set
            [section_credits_max]
            0}
         {if
            $hud_panel
            {$hud_panel
               set_review_result
               0
               [review_move_count]}}
         {$this
            set_performance_state_index
            0
            [initial_performance_state_index]
            TRUE})
      (recap_results
         {$this
            set_loop
            [start_beat]
            [end_beat]}
         {set
            [loop_count]
            0}
         {if
            {==
               [review_move_hit_count]
               [review_move_count]}
            {handle
               (hamprovider skills_review_done_100_percent)}}
         {if
            {&&
               {==
                  [review_move_hit_count]
                  [review_move_count]}
               {>
                  [review_move_count]
                  0}
               {profile_mgr has_active_profile}}
            {acc_mgr
               earn_accomplishment
               {profile_mgr get_active_profile}
               acc_bid_recap}}
         {handle
            (hamprovider skills_review_done)}
         {handle
            (hamprovider skills_freestyle_enter)}
         {if
            {!
               {hamprovider get byo_bid}}
            {$hud_panel play recap_01}}
         {do
            ($percentage
               {/
                  [review_move_hit_count]
                  [review_move_count]})
            ($category
               {$this
                  calc_result_category
                  $percentage
                  [review_result_category_thresholds]})
            ($delta
               {-
                  $category
                  [learn_section_result_category]})
            ($delta_cue
               {elem
                  [review_result_category_delta_cues]
                  {'+' $delta 3}})
            ($result_cue
               {elem
                  [review_result_category_cues]
                  $category})
            ($cue
               {if_else
                  {==
                     $delta_cue
                     ""}
                  $result_cue
                  $delta_cue})
            {if
               $hamwardrobe
               {cond
                  ({>= $percentage 0.75}
                     {handle
                        ($hamwardrobe crowd skills_great)})
                  ({>= $percentage 0.3}
                     {handle
                        ($hamwardrobe crowd skills_ok)})
                  {handle
                     ($hamwardrobe crowd skills_bad)}}}
            {if
               $hud_panel
               {$hud_panel play $cue}
               {if
                  [vo_spew]
                  {printf
                     "VO: Review end. %d / %d moves hit for %d%%. Cat. %d. Delta %d. Playing %s.cue.\n"
                     [review_move_hit_count]
                     [review_move_count]
                     {int
                        {'*' 100 $percentage}}
                     $category
                     $delta
                     $cue}}}}
         {if
            {>=
               [step_index]
               {-
                  [num_steps]
                  1}}
            {do
               ($fade_out_anim
                  {find_obj $hud_panel sound_bank skills_music_fade_out.anim})
               {if
                  $fade_out_anim
                  {$fade_out_anim
                     animate
                     (dest
                        {$fade_out_anim end_frame})}}}}
         {$hamdirector select_camera}
         {$hamdirector set shot SKILLS_RESULTS}
         {$hamdirector select_camera}
         {$hamdirector set disable_picking TRUE})})
(calc_result_category
   ($percentage $thresholds)
   {do
      ($result 0)
      {foreach
         $i
         $thresholds
         {if
            {>= $percentage $i}
            {'++' $result}}}
      $result})
(start_step
   {if
      {exists speech_mgr}
      {speech_mgr set_recognizing TRUE}}
   {$this
      set_loop
      [start_beat]
      [end_beat]}
   {$this set_limb_feedback_visible TRUE}
   {set
      [learn_skip]
      FALSE}
   {set
      [learn_previous]
      FALSE}
   {$hamdirector reteleport}
   {$hamdirector teleport_chars}
   {game reset_detection}
   {switch
      {hamprovider get skills_mode}
      (learn
         {set
            [learn_move_index]
            0}
         {resize
            [move_results]
            0}
         {do
            ($cur_world
               {$hamdirector get cur_world})
            ($phrase_meter0
               {find_obj $cur_world phrase_meter0 draw.grp})
            {if_else
               [video_replay_first_time]
               {$phrase_meter0 set_showing FALSE}
               {do
                  {$phrase_meter0 set_showing TRUE}
                  {handle
                     (hamprovider show_char_projection)}}}}
         {if
            {!
               [slow_motion]}
            {set
               [current_move_performed_slow]
               FALSE}}
         {action_bark_player set_active FALSE}
         {if
            [play_barks]
            {action_bark_player set bank_name barks}
            {foreach
               $elem
               [move_beats]
               {if_else
                  [slow_motion]
                  {action_bark_player
                     add_barks
                     {$hud_panel
                        move_from_beat
                        {'+' $elem 1}
                        0}
                     (verb_slow)
                     $elem}
                  {action_bark_player
                     add_barks
                     {$hud_panel
                        move_from_beat
                        {'+' $elem 1}
                        0}
                     (verb)
                     $elem}}}
            {action_bark_player set_active TRUE}}
         {if
            $hamdirector
            {set
               $face_name
               {if_else
                  {==
                     [learn_state]
                     slow_down}
                  {elem
                     [slow_learn_base_viseme]
                     0}
                  {elem
                     [learn_base_viseme]
                     0}}}
            {set
               $face_weight
               {if_else
                  {==
                     [learn_state]
                     slow_down}
                  {elem
                     [slow_learn_base_viseme]
                     1}
                  {elem
                     [learn_base_viseme]
                     1}}}
            {$hamdirector blend_face_clip $face_name $face_weight 1000}}
         {if
            {!=
               [user_action]
               ''}
            {switch
               [user_action]
               (PREVIOUS
                  {set
                     [learn_credit_category]
                     2}
                  {$this set_learn_state counting}
                  {set
                     [num_ticks]
                     0}
                  {do
                     ($timeline
                        {find_obj $hud_panel dynamic_hud})
                     {$timeline reset_ticks}
                     {$timeline show_tick_meter TRUE 0}})
               (CANCEL
                  {set
                     [learn_credit_category]
                     2}
                  {$this set_learn_state counting}
                  {do
                     ($timeline
                        {find_obj $hud_panel dynamic_hud})
                     {$timeline show_tick_meter TRUE 0}})
               (SLOW_DOWN
                  {set
                     [learn_credit_category]
                     2})}}
         {if
            {&&
               {hamprovider get byo_bid}
               {!=
                  [learn_state]
                  slow_down}}
            {set
               [learn_credit_category]
               2}
            {$this set_learn_state counting}
            {do
               ($timeline
                  {find_obj $hud_panel dynamic_hud})
               {$timeline show_tick_meter TRUE 0}}}
         {count_in_player
            set
            active
            {!
               [slow_motion]}}
         {count_in_player
            set_section
            [start_beat]
            [end_beat]}
         {slow_count_in_player
            set
            active
            [slow_motion]}
         {slow_count_in_player
            set_section
            [start_beat]
            [end_beat]}
         {if
            [want_to_record]
            {{find_obj $hud_panel practice_options}
               start_recording}
            {set
               [want_to_record]
               FALSE}
            {set
               [video_record]
               TRUE}}
         {if
            [video_replay]
            {{find_obj $hud_panel practice_options}
               start_playback}}
         {hamprovider set suppress_recap_results_text TRUE})
      (review
         {'++'
            [loop_count]}
         {if
            {==
               [loop_count]
               [full_review_count]}
            {if
               {==
                  [step_index]
                  {-
                     [num_steps]
                     1}}
               {audio clear_loop}
               {'+='
                  [end_beat]
                  8}}}
         {if
            $hamdirector
            {$hamdirector blend_face_overrides_out 1000}}
         {handle
            (hamprovider show_char_projection)}
         {hamprovider set suppress_recap_results_text FALSE}
         {if
            {hamprovider get byo_bid}
            {$hamdirector
               force_shot
               "practice_recap01.shot"}
            {$hamdirector set disable_picking FALSE}})}
   {set
      [user_action]
      ''})
(end_step
   {switch
      {hamprovider get skills_mode}
      (learn
         {$this hide_char_projection}
         {if
            [video_replay]
            {{find_obj $hud_panel practice_options}
               stop_playback}
            {if_else
               [video_replay_first_time]
               {do
                  {set
                     [video_replay_first_time]
                     FALSE}
                  {set
                     [suppress_next_move_score]
                     TRUE}
                  {do
                     ($timeline
                        {find_obj $hud_panel dynamic_hud})
                     {$timeline show_tick_meter TRUE 0}}
                  {$hud_panel play nar_post_video}}
               {'++'
                  [video_replay_loop_count]}}}
         {if
            [video_record]
            {{find_obj $hud_panel practice_options}
               stop_recording}
            {set
               [video_record]
               FALSE}
            {set
               [video_replay]
               TRUE}
            {set
               [video_replay_first_time]
               TRUE}
            {set
               [video_replay_loop_count]
               0}
            {hamprovider set video_replay TRUE}
            {$hud_panel play nar_watch_video}}
         {$this change_camera_angle})
      (review
         {if
            {>=
               [loop_count]
               [full_review_count]}
            {$this move_on}
            {handle
               (hamprovider hide_char_projection)}})
      (recap_results
         {if_else
            {<
               [step_index]
               {-
                  [num_steps]
                  1}}
            {$this move_on}
            {set
               [step_complete]
               TRUE}}
         {handle
            (hamprovider skills_learn)})})
(is_learn_streak
   ($move_rating)
   {do
      ($streak TRUE)
      ($rating_idx
         {rating_state_to_index $move_rating})
      {foreach
         $elem
         [move_results]
         {if
            {> $elem $rating_idx}
            {set $streak FALSE}}}
      $streak})
(learn_move_completed
   ($rating_idx)
   {do
      ($timeline
         {$hud_panel find dynamic_hud})
      ($move_beat
         {'+'
            [start_beat]
            4
            {'*'
               4
               [learn_move_index]}})
      ($is_last_move
         {==
            {-
               [end_beat]
               8}
            $move_beat})
      ($linked_streak
         {$this is_learn_streak move_awesome})
      ($perfected_streak
         {$this is_learn_streak move_perfect})
      ($use_failure_rules
         {&&
            {!
               {hamprovider get byo_bid}}
            {!
               [used_previous_this_move]}
            {!
               {$this in_video_replay_flow}}
            {!=
               [learn_state]
               slow_down}})
      {if
         {! $linked_streak}
         {if
            {==
               [learn_state]
               counting}
            {set
               [play_barks]
               TRUE}}}
      {if
         $is_last_move
         {do
            ($face_name
               {if_else
                  {==
                     [learn_state]
                     slow_down}
                  {elem
                     {elem
                        [slow_learn_result_faces]
                        $rating_idx}
                     0}
                  {elem
                     {elem
                        [learn_result_faces]
                        $rating_idx}
                     0}})
            ($face_weight
               {if_else
                  {==
                     [learn_state]
                     slow_down}
                  {elem
                     {elem
                        [slow_learn_result_faces]
                        $rating_idx}
                     1}
                  {elem
                     {elem
                        [learn_result_faces]
                        $rating_idx}
                     1}})
            {if
               $hamdirector
               {if
                  $hamwardrobe
                  {do
                     ($main_character
                        {$hamwardrobe get_character 0})
                     {$main_character set force_blink TRUE}}}
               {$hamdirector blend_face_clip $face_name $face_weight 1000}}
            {if
               {&&
                  {==
                     [learn_state]
                     slow_down}
                  {$this is_learn_streak move_perfect}
                  {profile_mgr has_active_profile}}
               {acc_mgr
                  earn_accomplishment
                  {profile_mgr get_active_profile}
                  acc_bid_slomo}}
            {if
               {&&
                  [video_replay]
                  {$this is_learn_streak move_perfect}
                  {profile_mgr has_active_profile}}
               {acc_mgr
                  earn_accomplishment
                  {profile_mgr get_active_profile}
                  acc_bid_video}}}
         {if_else
            {==
               [learn_state]
               fast_track}
            {if
               $perfected_streak
               {handle
                  (hamprovider learn_result_fasttrack)}}
            {if
               {!
                  {==
                     [learn_state]
                     slow_down}}
               {if_else
                  $linked_streak
                  {handle
                     (hamprovider learn_result_passed)}
                  {handle
                     (hamprovider learn_result_failed)}}}}
         {if
            $linked_streak
            {set
               [miss_streak]
               0}
            {'++'
               [pass_streak]}
            {if
               $hamwardrobe
               {handle
                  ($hamwardrobe crowd skills_great)}}
            {if
               {==
                  [learn_state]
                  counting}
               {'++'
                  [num_ticks]}
               {handle
                  (hamprovider skills_learn_earn_check)}
               {$timeline
                  award
                  [num_ticks]}}}
         {if
            {! $linked_streak}
            {if
               {!=
                  [learn_state]
                  fast_track}
               {'++'
                  [miss_streak]}
               {set
                  [pass_streak]
                  0}
               {if
                  $hamwardrobe
                  {handle
                     ($hamwardrobe crowd skills_bad)}}}
            {if
               {'||'
                  [learn_skip]
                  [learn_previous]}
               {while
                  {>
                     {size
                        [move_beats]}
                     {size
                        [move_results]}}
                  {push_back
                     [move_results]
                     0}}}
            #ifndef _SHIP
            {if
               {!=
                  {size
                     [move_beats]}
                  {size
                     [move_results]}}
               {notify
                  "size of [move_beats] != size of [move_results]. move_beats = "
                  [move_beats]
                  " move_results = "
                  [move_results]}}
            #endif
            {do
               ($timeline
                  {find_obj $hud_panel dynamic_hud})
               ($rating_threshold
                  {rating_state_to_index move_awesome})
               ($move_result 0)
               ($move_beat 0)
               {foreach_int
                  $i
                  0
                  {size
                     [move_beats]}
                  {set
                     $move_result
                     {elem
                        [move_results]
                        $i}}
                  {set
                     $move_beat
                     {elem
                        [move_beats]
                        $i}}
                  {if
                     {> $move_result $rating_threshold}
                     {$timeline highlight_flashcard $move_beat}}}}}
         {if
            {!
               [learn_mode_locked]}
            {'++'
               [loop_count]}
            {cond
               ({&&
                     {==
                        [learn_state]
                        fast_track}
                     $perfected_streak
                     {!
                        {hamprovider get byo_bid}}}
                  {$this move_on}
                  {$this award_current_moves kSkillsAward_FastTrack}
                  {$this
                     skills_bonus
                     {switch
                        [loop_count]
                        (1 skills_bonus_fasttrack_first)
                        (2 skills_bonus_fasttrack_second)}}
                  {$this set_learn_performance_state skills_learn_awesome}
                  {if
                     {profile_mgr has_active_profile}
                     {acc_mgr
                        earn_accomplishment
                        {profile_mgr get_active_profile}
                        acc_bid_fast_track}})
               ({>=
                     [num_ticks]
                     [learn_pass_max]}
                  {$this move_on}
                  {$this skills_bonus skills_bonus_learn_complete}
                  {$this award_current_moves kSkillsAward_Complete}
                  {$timeline show_tick_meter FALSE 0}
                  {$this set_slow FALSE TRUE})
               ({&&
                     {==
                        [learn_state]
                        fast_track}
                     {==
                        [loop_count]
                        [learn_fast_track_max]}}
                  {$this set_learn_state counting}
                  {$timeline show_tick_meter TRUE 0}
                  {do
                     ($vo nar_3rep_long)
                     ($time_til_loop
                        {-
                           {beat_to_seconds
                              [end_beat]}
                           {master stream_time}})
                     ($new_loop_start 0)
                     {if
                        [played_first_3rep]
                        {set $vo nar_3rep_short}}
                     {set
                        [played_first_3rep]
                        TRUE}
                     {set
                        $new_loop_start
                        {$this
                           determine_seq_start_beat
                           $vo
                           [start_beat]
                           $time_til_loop}}
                     {if
                        {<
                           $new_loop_start
                           [start_beat]}
                        {$this
                           set_loop
                           $new_loop_start
                           [end_beat]}
                        {count_in_player set ignore_next TRUE}}
                     {$hud_panel play $vo}}
                  {set
                     [learn_credit_category]
                     2})
               ({&&
                     {>=
                        [miss_streak]
                        [learn_miss_streak_max]}
                     $use_failure_rules}
                  {switch
                     [learn_state]
                     (counting
                        {$this fail_learn_move})})
               ({&&
                     {==
                        [miss_streak]
                        [learn_miss_encourage]}
                     {==
                        [learn_state]
                        counting}}
                  {$hud_panel play nar_3rep_last})
               ({&&
                     {>
                        [miss_streak]
                        0}
                     {==
                        {mod
                           [miss_streak]
                           [learn_controls_inform]}
                        0}
                     {! $use_failure_rules}
                     {!
                        {$this in_video_replay_flow}}
                     {!=
                        [learn_state]
                        slow_down}}
                  {$this voice_command_inform})
               ({&&
                     {>
                        [pass_streak]
                        0}
                     {==
                        {mod
                           [pass_streak]
                           [learn_slow_controls_inform]}
                        0}
                     {==
                        [learn_state]
                        slow_down}}
                  {$this
                     set_loop
                     {-
                        [start_beat]
                        2}
                     [end_beat]}
                  {slow_count_in_player set ignore_next TRUE}
                  {if_else
                     {!
                        {profile_mgr get_disable_voice_practice}}
                     {$hud_panel play nar_learn_speed}
                     {$hud_panel play nar_learn_speed_ges}})
               ({&&
                     {>
                        [miss_streak]
                        0}
                     {==
                        {mod
                           [miss_streak]
                           [learn_slow_controls_inform]}
                        0}
                     {==
                        [learn_state]
                        slow_down}}
                  {$this
                     set_loop
                     {-
                        [start_beat]
                        2}
                     [end_beat]}
                  {slow_count_in_player set ignore_next TRUE}
                  {if_else
                     {!
                        {profile_mgr get_disable_voice_practice}}
                     {$hud_panel play nar_learn_speed_fail}
                     {$hud_panel play nar_learn_speed_fail_ges}})
               ({&&
                     {==
                        [video_replay_loop_count]
                        [learn_video_controls_inform]}
                     [video_replay]}
                  {$this
                     set_loop
                     {-
                        [start_beat]
                        4}
                     [end_beat]}
                  {count_in_player set ignore_next TRUE}
                  {if_else
                     {!
                        {profile_mgr get_disable_voice_practice}}
                     {$hud_panel play nar_learn_stop_video}
                     {$hud_panel play nar_learn_stop_video_ges}})
               ({&&
                     {>
                        [video_replay_loop_count]
                        [learn_video_controls_inform]}
                     {==
                        {mod
                           [video_replay_loop_count]
                           [learn_video_controls_inform]}
                        0}
                     [video_replay]}
                  {$this
                     set_loop
                     {-
                        [start_beat]
                        4}
                     [end_beat]}
                  {count_in_player set ignore_next TRUE}
                  {if_else
                     {>=
                        [miss_streak]
                        [learn_video_controls_inform]}
                     {if_else
                        {!
                           {profile_mgr get_disable_voice_practice}}
                        {$hud_panel play nar_learn_skip}
                        {$hud_panel play nar_learn_skip_ges}}
                     {if_else
                        {!
                           {profile_mgr get_disable_voice_practice}}
                        {$hud_panel play nar_learn_stop_video}
                        {$hud_panel play nar_learn_stop_video_ges}}})}}}
      {'++'
         [learn_move_index]}})
(voice_command_inform
   {do
      ($num_extra_beats 4)
      {cond
         ({&&
               [informed_video]
               [informed_slow]}
            {if_else
               {!
                  {profile_mgr get_disable_voice_practice}}
               {$hud_panel play nar_learn_skip}
               {$hud_panel play nar_learn_skip_ges}}
            {set
               [informed_video]
               FALSE}
            {set
               [informed_slow]
               FALSE})
         ([informed_video]
            {if_else
               {!
                  {profile_mgr get_disable_voice_practice}}
               {$hud_panel play nar_learn_slow}
               {$hud_panel play nar_learn_slow_ges}}
            {set
               [informed_slow]
               TRUE})
         ([informed_slow]
            {if_else
               {!
                  {profile_mgr get_disable_voice_practice}}
               {$hud_panel play nar_learn_record}
               {$hud_panel play nar_learn_record_ges}}
            {set $num_extra_beats 8}
            {set
               [informed_video]
               TRUE})
         {switch
            {random_int 0 2}
            (0
               {if_else
                  {!
                     {profile_mgr get_disable_voice_practice}}
                  {$hud_panel play nar_learn_slow}
                  {$hud_panel play nar_learn_slow_ges}}
               {set
                  [informed_slow]
                  TRUE})
            (1
               {if_else
                  {!
                     {profile_mgr get_disable_voice_practice}}
                  {$hud_panel play nar_learn_record}
                  {$hud_panel play nar_learn_record_ges}}
               {set $num_extra_beats 8}
               {set
                  [informed_video]
                  TRUE})}}
      {$this
         set_loop
         {-
            [start_beat]
            $num_extra_beats}
         [end_beat]}
      {count_in_player set ignore_next TRUE}})
(fail_learn_move
   {do
      ($s)
      ($e)
      ($num_extra_beats)
      {$this award_current_moves kSkillsAward_Fail}
      {do
         ($timeline
            {find_obj $hud_panel dynamic_hud})
         {$timeline show_tick_meter FALSE 0}}
      {$this set_slow FALSE TRUE}
      {handle
         (hamprovider skills_learn_fail_move)}
      {$hud_panel play skills_fail}
      {if_else
         {$this need_inform_previous}
         {do
            {if_else
               {!
                  {profile_mgr get_disable_voice_practice}}
               {$hud_panel play nar_learn_previous}
               {$hud_panel play nar_learn_previous_ges}}
            {set $num_extra_beats 8}}
         {do
            {$hud_panel play nar_test_fail}
            {set $num_extra_beats 4}}}
      {audio get_loop_beats $s $e}
      {set
         [end_beat]
         {'+' $e $num_extra_beats}}
      {$this
         set_loop
         $s
         [end_beat]}
      {set
         [learn_credit_category]
         0}
      {$this move_on}})
(need_inform_previous TRUE)
(set_slow
   ($slow $fade)
   {set
      [slow_motion]
      $slow}
   {if
      $hud_panel
      {$hud_panel set_slow $slow $fade}}
   {if_else
      $slow
      {do
         {set
            [current_move_performed_slow]
            TRUE}
         {set
            [play_barks]
            TRUE}
         {set
            [used_slow_motion]
            TRUE}}
      {do
         {set
            [play_barks]
            FALSE}}})
(setup_timeline
   {do
      ($timeline
         {$hud_panel find dynamic_hud})
      {switch
         {hamprovider get skills_mode}
         (learn
            {$timeline clear_moves}
            {do
               ($done FALSE)
               ($learn_section_start
                  [step_index])
               {while
                  {!
                     {$this is_section_boundary $learn_section_start 1}}
                  {-- $learn_section_start}}
               {foreach_int
                  $i
                  $learn_section_start
                  [num_steps]
                  {if
                     {! $done}
                     {if_else
                        {'||'
                           {!
                              {[section]
                                 get
                                 (steps $i boundary)}}
                           {== $i $learn_section_start}}
                        {do
                           ($start_beat
                              {$this
                                 beat_from_tag
                                 {[section]
                                    get
                                    (steps $i start)}})
                           ($end_beat
                              {$this
                                 beat_from_tag
                                 {[section]
                                    get
                                    (steps $i end)}})
                           ($num_moves
                              {int
                                 {/
                                    {- $end_beat $start_beat}
                                    4}})
                           ($b 0)
                           ($move
                              "")
                           ($award_key
                              {$this construct_award_key $start_beat $num_moves})
                           {foreach_int
                              $j
                              0
                              $num_moves
                              {set
                                 $b
                                 {round
                                    {'+'
                                       $start_beat
                                       {'*' 4 $j}}}}
                              {set
                                 $move
                                 {$hud_panel move_from_beat $b 0}}
                              {$timeline add_move $move $b}
                              {$timeline
                                 set_move_award
                                 $b
                                 {if_else
                                    {== $j 0}
                                    {meta_performer get_award $award_key}
                                    kSkillsAward_Unplayed}
                                 FALSE
                                 FALSE}
                              {do
                                 ($flash_card
                                    {$timeline find_flashcard $b})
                                 {if
                                    {! $flash_card}
                                    {print
                                       "Please assign to Daniel Chace... Number of flashcards in a group: "
                                       $j
                                       ". Can't be more than 4. step = "
                                       $i
                                       "\n"}}
                                 {$flash_card
                                    set_num_links
                                    {if_else
                                       {== $j 0}
                                       $num_moves
                                       0}}}}}
                        {set $done TRUE}}}}})
         (review
            {do
               ($done FALSE)
               ($start_beat
                  {$this
                     beat_from_tag
                     {[section]
                        get
                        (steps
                           [step_index]
                           start)}})
               ($end_beat
                  {$this
                     beat_from_tag
                     {[section]
                        get
                        (steps
                           [step_index]
                           end)}})
               ($move_count
                  {int
                     {/
                        {- $end_beat $start_beat}
                        4}})
               {set
                  [review_move_number]
                  0}
               {set
                  [review_move_count]
                  $move_count}
               {set
                  [review_move_hit_count]
                  0}
               {set
                  [review_move_perfect_count]
                  0}})}})
(move_passed
   ($player $move $detect_frac)
   {if
      {== $player 0}
      {do
         ($is_rest
            {$move is_rest})
         ($done FALSE)
         ($rating
            {detect_frac_to_rating $detect_frac $move})
         ($rating_idx
            {rating_state_to_index $rating})
         {unless
            {'||'
               $is_rest
               {!= $player 0}
               [learn_skip]
               [learn_previous]}
            {switch
               {hamprovider get skills_mode}
               (learn
                  {if_else
                     {$this score_move}
                     {do
                        {meta_performer move_passed $player $move $rating_idx $detect_frac}
                        {handle
                           (hamprovider move_finished $player $rating)}
                        {if
                           {&&
                              {size
                                 [move_beats]}
                              {>=
                                 [learn_move_index]
                                 0}}
                           {push_back
                              [move_results]
                              $rating_idx}
                           {$this learn_move_completed $rating_idx}}}
                     {do
                        {if
                           {$this is_tracking_score}
                           {handle
                              (hamprovider move_finished $player $rating)}}
                        {set
                           [suppress_next_move_score]
                           FALSE}}})
               (review
                  {meta_performer move_passed $player $move $rating_idx $detect_frac}
                  {meta_performer review_move_passed $player $move $rating_idx $detect_frac}
                  {handle
                     (hamprovider move_finished $player $rating)}
                  {if
                     {<=
                        $rating_idx
                        {rating_state_to_index move_awesome}}
                     {'++'
                        [review_move_hit_count]}
                     {if
                        $hud_panel
                        {$hud_panel
                           set_review_result
                           [review_move_hit_count]
                           [review_move_count]}}}
                  {if
                     {<=
                        $rating_idx
                        {rating_state_to_index move_perfect}}
                     {'++'
                        [review_move_perfect_count]}}
                  {'++'
                     [review_move_number]}
                  {do
                     ($next_state_index
                        {$this
                           next_performance_state_index
                           $rating_idx
                           {{gamedata
                                 getp
                                 {hamprovider get ui_nav_player}
                                 provider}
                              get
                              performance_index}})
                     {$this set_performance_state_index 0 $next_state_index FALSE}}
                  {if
                     {==
                        [review_move_number]
                        [review_move_count]}
                     {'+='
                        [review_total_move_count]
                        [review_move_count]}
                     {'+='
                        [review_total_move_hit_count]
                        [review_move_hit_count]}
                     {set
                        [section_credits]
                        0}
                     {set
                        [section_credits_max]
                        0}}
                  {if
                     $hamwardrobe
                     {cond
                        ({<=
                              $rating_idx
                              {rating_state_to_index move_awesome}}
                           {handle
                              ($hamwardrobe crowd skills_great)})
                        ({<=
                              $rating_idx
                              {rating_state_to_index move_ok}}
                           {handle
                              ($hamwardrobe crowd skills_ok)})
                        {handle
                           ($hamwardrobe crowd skills_bad)}}})}}}})
(hide_char_projection
   {handle
      (hamprovider hide_char_projection)}
   {$this set_limb_feedback_visible FALSE}
   {$this reset_limb_feedback})
(on_practice_options_show
   {set
      [miss_streak]
      0})
(on_previous
   {if_else
      {&&
         {!
            [learn_skip]}
         {!
            [learn_previous]}
         {>
            [step_index]
            0}}
      {do
         {set
            [learn_previous]
            TRUE}
         {set
            [stream_jump_happened_since_navigation]
            FALSE}
         {$this cancel_video_replay}
         {if
            [slow_motion]
            {$this set_slow FALSE TRUE}}
         {set
            [user_action]
            PREVIOUS}
         {gameplay_event_scheduler reset}
         {$this hide_char_projection}
         {$this stop_flash_card_pulse}
         {$hud_panel stop_narrator}
         {$this move_on}
         {$hud_panel stop_narrator}
         {action_bark_player set_active FALSE}
         {count_in_player set active FALSE}
         {slow_count_in_player set active FALSE}
         {if
            {! $suppress_narrator}
            {$hud_panel play nar_previous}}
         TRUE}
      FALSE})
(on_skip
   {if_else
      {&&
         {!
            [learn_skip]}
         {!
            [learn_previous]}}
      {do
         {set
            [learn_skip]
            TRUE}
         {set
            [stream_jump_happened_since_navigation]
            FALSE}
         {$this cancel_video_replay}
         {if
            [slow_motion]
            {$this set_slow FALSE TRUE}}
         {gameplay_event_scheduler reset}
         {$hud_panel stop_narrator}
         {$this move_on}
         {$hud_panel stop_narrator}
         {action_bark_player set_active FALSE}
         {count_in_player set active FALSE}
         {slow_count_in_player set active FALSE}
         {if
            {! $suppress_narrator}
            {$hud_panel play nar_skip}}
         {$this hide_char_projection}
         {$this stop_flash_card_pulse}
         TRUE}
      FALSE})
(cancel_navigation FALSE)
(on_slow_down
   {if_else
      {&&
         {!
            [step_complete]}
         {==
            {hamprovider get skills_mode}
            learn}}
      {do
         ($section_start
            {[section]
               get
               (steps
                  [step_index]
                  start)})
         ($section_end
            {[section]
               get
               (steps
                  [step_index]
                  end)})
         ($timeline
            {find_obj $hud_panel dynamic_hud})
         ($cur_loop_start)
         ($cur_loop_end)
         {$this cancel_video_replay}
         {$hud_panel stop_narrator}
         {action_bark_player set_active FALSE}
         {count_in_player set active FALSE}
         {slow_count_in_player set active FALSE}
         {if
            {! $suppress_narrator}
            {$hud_panel play nar_slow_intro}}
         {set
            [learn_credit_category]
            1}
         {set
            [miss_streak]
            0}
         {set
            [pass_streak]
            0}
         {set
            [informed_slow]
            TRUE}
         {set
            [user_action]
            SLOW_DOWN}
         {$timeline
            retract_move_award
            {elem
               [move_beats]
               0}}
         {$this skills_bonus skills_bonus_enter_slowdown}
         {$this set_slow TRUE TRUE}
         {if
            {<
               {'+'
                  {taskmgr beat}
                  4}
               [end_beat]}
            {$this hide_char_projection}
            {$this stop_flash_card_pulse}
            {$this
               set_loop
               [start_beat]
               {'*'
                  4
                  {'+'
                     2
                     {int
                        {/
                           {taskmgr beat}
                           4}}}}}}
         {$timeline show_tick_meter FALSE 0}
         {$this set_learn_state slow_down}
         {gameplay_event_scheduler reset}
         TRUE}
      FALSE})
(on_speed_up
   {do
      ($timeline
         {find_obj $hud_panel dynamic_hud})
      {$this set_slow FALSE TRUE}
      {$this set_learn_state counting}
      {$timeline show_tick_meter TRUE 0}
      {set
         [miss_streak]
         0}
      {set
         [pass_streak]
         0}
      {$hud_panel stop_narrator}
      {action_bark_player set_active FALSE}
      {count_in_player set active FALSE}
      {slow_count_in_player set active FALSE}
      {if
         {! $suppress_narrator}
         {$hud_panel play nar_speed_up}}
      TRUE})
(on_video_replay
   {if_else
      {==
         {hamprovider get skills_mode}
         learn}
      {do
         ($timeline
            {find_obj $hud_panel dynamic_hud})
         {if_else
            {!
               {$this in_video_replay_flow}}
            {do
               ($end)
               {if
                  [slow_motion]
                  {$this set_slow FALSE TRUE}}
               {set
                  [want_to_record]
                  TRUE}
               {$this set_learn_state counting}
               {set
                  [miss_streak]
                  0}
               {set
                  [pass_streak]
                  0}
               {$timeline show_tick_meter FALSE 0}
               {$this hide_char_projection}
               {$this stop_flash_card_pulse}
               {$hud_panel stop_narrator}
               {action_bark_player set_active FALSE}
               {count_in_player set active FALSE}
               {slow_count_in_player set active FALSE}
               {if
                  {! $suppress_narrator}
                  {$hud_panel play nar_record}}
               {set
                  [informed_video]
                  TRUE}
               {if_else
                  {$this is_past_stream_jump_point_of_no_return}
                  {do
                     {set
                        $end
                        {'+'
                           [start_beat]
                           4}}
                     {set
                        [queued_start_beat]
                        [start_beat]}
                     {set
                        [queued_end_beat]
                        $end}
                     {set
                        [suppress_next_start_step]
                        TRUE}
                     {count_in_player set active FALSE}}
                  {do
                     {set
                        $end
                        {'*'
                           4
                           {'+'
                              2
                              {int
                                 {/
                                    {taskmgr beat}
                                    4}}}}}
                     {$this
                        set_loop
                        [start_beat]
                        $end}}}}
            {do
               {$this cancel_video_replay}
               {$this on_video_replay}}}
         TRUE}
      FALSE})
(in_video_replay_flow
   {'||'
      [want_to_record]
      [video_record]
      [video_replay]})
(cancel_video_replay
   {set
      [miss_streak]
      0}
   {set
      [pass_streak]
      0}
   {do
      ($timeline
         {$hud_panel find dynamic_hud})
      ($cancelled FALSE)
      {cond
         ([want_to_record]
            {set
               [want_to_record]
               FALSE}
            {$timeline show_tick_meter TRUE 0}
            {set $cancelled TRUE})
         ([video_record]
            {set
               [video_record]
               FALSE}
            {{find_obj $hud_panel practice_options}
               stop_recording}
            {$timeline show_tick_meter TRUE 0}
            {set $cancelled TRUE})
         ([video_replay]
            {set
               [video_replay]
               FALSE}
            {set
               [video_replay_first_time]
               FALSE}
            {{find_obj $hud_panel practice_options}
               stop_playback}
            {$timeline show_tick_meter TRUE 0}
            {set $cancelled TRUE})}
      {if
         $cancelled
         {hamprovider set video_replay FALSE}
         {set
            [loop_cam_index]
            0}
         {$this change_camera_angle}}
      $cancelled})
(set_loop
   ($start $end)
   {audio set_loop $start $end}
   {$this update_margins}
   {set
      [queued_start_beat]
      -1}
   {set
      [queued_end_beat]
      -1})
(update_margins
   {if
      $hamdirector
      {do
         ($practice_start)
         ($practice_end)
         ($loop_start)
         ($loop_end)
         {audio get_loop_beats $loop_start $loop_end}
         {$hamdirector practice_beats $practice_start $practice_end}
         {set
            [next_loop_start_margin]
            {round
               {/
                  {- $practice_start $loop_start}
                  4}}}
         {$hamdirector
            set
            end_loop_margin
            {round
               {/
                  {- $loop_end $practice_end}
                  4}}}}})
(cached_loop_cams
   ())
(loop_cam_index 0)
(change_camera_angle
   {if
      $hamdirector
      {do
         ($dir
            {$hamdirector get cur_world})
         ($picked
            "")
         ($cam_list
            ())
         {if_else
            {&&
               {<=
                  [loop_cam_index]
                  0}
               {!
                  [video_replay]}}
            {if
               $dir
               {$dir
                  iterate
                  HamCamShot
                  $shot
                  {if
                     {==
                        {$shot get category}
                        PRACTICE}
                     {set $picked $shot}}}}
            {do
               ($index
                  [loop_cam_index])
               ($cur_shot
                  {$hamdirector get cur_shot})
               {if
                  {&&
                     $dir
                     {!
                        {size
                           [cached_loop_cams]}}}
                  {$dir
                     iterate
                     HamCamShot
                     $shot
                     {if
                        {==
                           {$shot get category}
                           PRACTICE_LOOP}
                        {push_back
                           [cached_loop_cams]
                           $shot}}}
                  {sort
                     [cached_loop_cams]}}
               {cond
                  ({&&
                        $dir
                        [video_replay_first_time]}
                     {set
                        $picked
                        {find_obj
                           $dir
                           "practice_playback_first.shot"}})
                  ({&&
                        $dir
                        [video_replay]}
                     {if
                        {==
                           [video_replay_loop_count]
                           0}
                        {set
                           $picked
                           {find_obj
                              $dir
                              "practice_playback.shot"}}})
                  (TRUE
                     {-- $index}
                     {if
                        {size
                           [cached_loop_cams]}
                        {set
                           $index
                           {mod
                              $index
                              {size
                                 [cached_loop_cams]}}}
                        {set
                           $picked
                           {elem
                              [cached_loop_cams]
                              $index}}})}}}
         {if
            $picked
            {$hamdirector
               force_shot
               {$picked name}}}
         {'++'
            [loop_cam_index]}}})
(skills_bonus
   ($bonus_name)
   {handle
      (hamprovider $bonus_name)})
(set_learn_state
   ($learn_state)
   {set
      [learn_state]
      $learn_state}
   {switch
      [learn_state]
      (fast_track
         {if
            {!=
               [performance_state]
               skills_learn_awesome}
            {$this set_learn_performance_state skills_learn_high}})
      (counting
         {$this set_learn_performance_state skills_learn_high})
      (slow_down
         {$this set_learn_performance_state skills_learn_low})})
(set_learn_performance_state
   ($performance_state)
   {if
      {!=
         [performance_state]
         $performance_state}
      {set
         [performance_state]
         $performance_state}})
(award_current_moves
   ($award)
   {do
      ($timeline
         {$hud_panel find dynamic_hud})
      ($move_name '')
      ($first TRUE)
      ($move_beat
         {elem
            [move_beats]
            0})
      ($award_key
         {$this
            construct_award_key
            $move_beat
            {size
               [move_beats]}})
      {foreach
         $b
         [move_beats]
         {set
            $move_name
            {$hamdirector beat_to_movename $b 0}}
         {meta_performer
            practice_move_passed
            $player
            $move_name
            $award
            [used_slow_motion]}
         {set
            [used_slow_motion]
            FALSE}
         {if
            {&& $first $timeline}
            {meta_performer set_award $award_key $award}
            {$timeline set_move_award $move_beat $award TRUE FALSE}}
         {set $first FALSE}}})
(construct_award_key
   ($start_beat $num_moves)
   {do
      ($key
         {array 0})
      {foreach_int
         $j
         0
         $num_moves
         {push_back
            $key
            {$hud_panel
               move_from_beat
               {round
                  {'+'
                     $start_beat
                     {'*' 4 $j}}}
               0}}}
      $key})
(is_section_boundary
   ($step_index $direction)
   {cond
      ({== $step_index 0}
         TRUE)
      ({[section]
            get
            (steps $step_index boundary)}
         TRUE)
      ({[section]
            get
            (steps
               {- $step_index $direction}
               boundary)}
         TRUE)
      (TRUE FALSE)})
(reset
   {$this common_reset}
   {meta_performer set_skip_practice_welcome FALSE}
   {resize
      [cached_loop_cams]
      0}
   {set
      [learn_mode_locked]
      FALSE}
   {set
      [learn_move_index]
      -1}
   {resize
      [move_beats]
      0}
   {meta_performer clear_skills_awards}
   {$this setup_section}
   {set
      [num_steps]
      {[section]
         size
         (steps)}}
   {if
      {&&
         $hamdirector
         {>
            [num_steps]
            0}}
      {$hamdirector
         set
         practice_start
         {[section]
            get
            (steps 0 start)}}
      {$hamdirector
         set
         practice_end
         {[section]
            get
            (steps 0 end)}}}
   {foreach_int
      $i
      0
      {gamedata max_players}
      {do
         ($provider
            {gamedata getp $i provider})
         {$provider
            clear
            (tagged_moves)}}}
   {set
      [step_index]
      -1}
   {hamprovider set skills_mode start}
   {set
      [step_complete]
      TRUE}
   {set
      [played_first_express]
      FALSE}
   {set
      [played_first_3rep]
      FALSE}
   {$this
      set_performance_state_index
      0
      [initial_performance_state_index]
      TRUE}
   {set
      [performance_state]
      ''}
   {$this set_learn_performance_state skills_learn_high}
   {$this setup_fade_anim}
   {$this set_slow FALSE FALSE}
   {if
      $hud_panel
      {do
         ($intro_vo
            {if_else
               {hamprovider get byo_bid}
               nar_3rep_short
               nar_express_long})
         {{{$hud_panel find sound_bank}
               find
               music_level.fade}
            set
            level
            [base_music_volume]}
         {do
            ($start_beat
               {-
                  {$this
                     beat_from_tag
                     {[section]
                        get
                        (steps 0 start)}}
                  4})
            {set
               $start_beat
               {$this determine_seq_start_beat $intro_vo $start_beat 0}}
            {if
               {> $start_beat 0}
               {audio set_loop $start_beat 1.0e-2}}}}}
   {hamprovider set cam_player_config kHamPlayer0}
   {foreach_int
      $i
      0
      {gamedata max_players}
      {do
         ($provider
            {gamedata getp $i provider})
         {$provider set score 0}
         {$provider set start_score_move_index 0}}}
   {midi_player init}
   {set
      [loop_cam_index]
      0}
   {set
      [section_credits]
      0}
   {set
      [section_credits_max]
      0}
   {set
      [review_total_move_count]
      0}
   {set
      [review_total_move_hit_count]
      0}
   {set
      [learn_skip]
      FALSE}
   {set
      [learn_previous]
      FALSE}
   {set
      [used_previous_this_move]
      FALSE}
   {resize
      [move_results]
      0}
   {set
      [next_loop_start_margin]
      -1}
   {set
      [queued_start_beat]
      -1}
   {set
      [queued_end_beat]
      -1}
   {set
      [nav_direction]
      1}
   {set
      [current_move_performed_slow]
      FALSE}
   {set
      [suppress_next_start_step]
      FALSE}
   {hamprovider set video_replay FALSE}
   {game reset_detection}
   {$hamdirector set freestyle_enabled FALSE})
(world_unpause
   {if
      [video_replay]
      {handle
         (hamprovider video_playback_unpause)}}
   kDataUnhandled)
(world_pause
   {if
      [video_replay]
      {handle
         (hamprovider video_playback_pause)}}
   kDataUnhandled)
(pause_on_skeleton_loss
   {!=
      {hamprovider get skills_mode}
      start})
(beat
   {do
      ($beats_til_end
         {-
            [end_beat]
            $beat})
      {if
         {&&
            {==
               $beat
               [start_beat]}
            {!
               [step_complete]}}
         {if
            {!
               [suppress_next_start_step]}
            {$this start_step}}
         {set
            [suppress_next_start_step]
            FALSE}}
      {if
         {==
            {hamprovider get skills_mode}
            recap_results}
         {switch
            $beats_til_end
            (3
               {do
                  ($vocals_out_anim
                     {find_obj $hud_panel sound_bank vocals_fadeout.anim})
                  {if
                     $vocals_out_anim
                     {$vocals_out_anim
                        animate
                        (dest
                           {$vocals_out_anim end_frame})}}})}}
      {if
         {==
            {hamprovider get skills_mode}
            review}
         {switch
            $beats_til_end
            (7
               {do
                  ($blend_ms
                     {'*'
                        1000
                        {-
                           {beat_to_seconds
                              {-
                                 [end_beat]
                                 4}}
                           {beat_to_seconds $beat}}})
                  {$hamdirector blend_face_overrides_in 100}
                  {$hamdirector blend_face_clip Smile 1.0 $blend_ms}})}}
      {if
         {<=
            {abs
               {-
                  $beat
                  {-
                     [end_beat]
                     4}}}
            1.0e-3}
         {$this end_step}}
      {if
         {&&
            {==
               3
               {mod $beat 4}}
            {!
               [suppress_flash_card_pulse]}}
         {do
            ($timeline
               {$hud_panel find dynamic_hud})
            ($next_move_beat
               {'+' $beat 1})
            ($flashcard
               {$timeline find_flashcard $next_move_beat})
            {if
               {&&
                  {find_elem
                     [move_beats]
                     $next_move_beat}
                  $flashcard}
               {{$flashcard find beat.anim}
                  animate
                  (range -480 1920)}}}}
      {do
         ($start)
         ($end)
         {if
            {$hamdirector practice_beats $start $end}
            {if
               {==
                  $beat
                  {round $start}}
               {handle
                  (hamprovider practice_move_start)}}
            {if
               {==
                  $beat
                  {-
                     {round $start}
                     1}}
               {handle
                  (hamprovider char_projection_move_active)}}
            {if
               {==
                  $beat
                  {round $end}}
               {handle
                  (hamprovider char_projection_move_inactive)}
               {handle
                  (hamprovider practice_move_end)}}}}}
   kDataUnhandled)
(setup_fade_anim
   {if
      $hud_panel
      {do
         ($sound_bank
            {$hud_panel find sound_bank})
         ($prop_anim
            {$sound_bank find skills_cross_fade.anim})
         {if
            $prop_anim
            {$prop_anim
               add_keys
               midi_player
               (active)
               kPropBool}
            {$prop_anim
               set_key_val
               midi_player
               (active)
               0
               FALSE}
            {$prop_anim
               set_key_val
               midi_player
               (active)
               60
               TRUE}}}})
(is_tracking_score
   {'||'
      {&&
         {!
            [learn_skip]}
         {!
            [learn_previous]}
         {! $practice_options_up}
         {!
            [want_to_record]}
         {!=
            [user_action]
            SLOW_DOWN}
         {!
            [video_replay_first_time]}
         {!
            [suppress_next_move_score]}}
      {==
         {hamprovider get skills_mode}
         review}})
(score_move
   {&&
      {$this is_tracking_score}
      {!
         [video_record]}})
(is_slow
   [slow_motion])
(update_control_state
   {if_else
      [slow_motion]
      {handle
         (hamprovider show_slow_icon)}
      {handle
         (hamprovider hide_slow_icon)}})
(stop_flash_card_pulse
   {set
      [suppress_flash_card_pulse]
      TRUE}
   {do
      ($timeline
         {$hud_panel find dynamic_hud})
      ($flashcard
         {$timeline find_flashcard $beat})
      {if
         {&&
            {find_elem
               [move_beats]
               $beat}
            $flashcard}
         {{$flashcard find beat.anim}
            animate
            (range -480 -480)}}})
(cheat_skip_section
   {set
      [step_complete]
      TRUE}
   {$this stream_jump}
   {game
      jump
      {max
         {beat_to_ms
            {-
               [start_beat]
               8}}
         0}}
   {$this set_slow FALSE FALSE})